pipeline {
  agent any
    environment {
        NETLIFY_SITE_ID = '6b6de050-4976-4683-9ea8-4b2c892525dc'
        NETLIFY_AUTH_TOKEN = credentials('netlifytoken')
    }
  stages {

    stage ('Test') {
      agent {
        docker { image 'node:18-alpine'; reuseNode true }
      }
      steps {
        sh '''
        #test -f build/index.html
        npm test
        '''
      }
    }

    stage ('Deploy') {
      agent {
        docker { image 'node:18-alpine'; reuseNode true }
      }
      steps {
        sh '''
         npm install netlify-cli
         node_modules/.bin/netlify --version
         echo "Deployin to Prod Site ID: $NETLIFY_SITE_ID"
         node_modules/.bin/netlify status
         node_modules/.bin/netlify deploy --dir=build --prod
        '''
      }  // <-- Closing steps
    }    // <-- Closing Deploy stage

    stage ('E2E') {
      agent {
        docker {
          image 'mcr.microsoft.com/playwright:v1.55.0-noble'
          reuseNode true
        }
      }
      steps {
        sh '''
        npm install serve
        npx playwright install
        node_modules/.bin/serve -s build &
        sleep 10
        npx playwright test
        '''
      }
    }

  }  // <-- Closing stages block

  post {
    always {
      junit 'jest-results/junit.xml'
    }
  }
}
